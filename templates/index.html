<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous" />
        <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
        <script>
$(function() {
    let guestbookPosts = new Vue({
        el: '.container',
        delimiters: ['[[', ']]'],
        data: {
            posts: []
        },
        mounted: function() {
            $('#guestbook-message').focus()
            this.get()
        },
        methods: {
            get: function() {
                let self = this
                $.ajax({
                    cache: false,
                    url: '/guestbook',
                    success: function(data, textStatus, jqXHR) {
                        self.posts = data.posts.reverse()
                    }
                })
            },
            post: function(name, message) {
                let self = this
                $.ajax({
                    cache: false,
                    url: '/guestbook',
                    method: 'post',
                    data: {name: name, message: message},
                    success: function(data, textStatus, jqXHR) {
                        self.posts = data.posts.reverse()
                    }
                })
            },
            toDatetime: function(timestamp) {
                function zfill(s, digits) {
                    s = s + ''
                    while(s.length < digits)
                        s = '0' + s
                    return s
                }
                let dt = new Date(timestamp * 1000);
                return zfill(dt.getFullYear(), 4) + '/'
                    + zfill(dt.getMonth() + 1, 2) + '/'
                    + zfill(dt.getDate(), 2) + ' '
                    + zfill(dt.getHours(), 2) + ':'
                    + zfill(dt.getMinutes(), 2) + ':'
                    + zfill(dt.getSeconds(), 2)
            },
            postClick: function() {
                let name = $('#guestbook-name').val()
                let message = $('#guestbook-message').val()
                this.post(name, message)
                $('#guestbook-message').val('')
            }
        }
    })
})
        </script>
        <style>
body {
    font-family: 'Helvetica Neue', 'Helvetica', 'Meiryo UI', 'Meiryo',
        'HiraKakuProN-W3', 'VL Gothic', sans-serif;
}

[v-cloak] {
    display: none !important;
}

div.guestbook-posts {
    font-size: 18pt;
}

div.guestbook-posts-name {
    font-weight: bold;
}

div.guestbook-posts-name::after {
    color: #999999;
    content: ' \ff1e ';
    padding-left: 0.25rem;
    padding-right: 0.25rem;
}

div.guestbook-posts-datetime {
    color: #999999;
    font-size: 12pt;
}
        </style>
        <title>Guestbook</title>
    </head>
    <body>
        <nav class="navbar navbar-extend navbar-dark bg-dark">
            <h3 class="text-light">Guestbook</h3>
        </nav>
        <div class="container">
            <div class="form-group row mt-4">
                <label class="col-2 col-form-label text-right">Name</label>
                <div class="col-3">
                    <input type="text" class="form-control" id="guestbook-name" value="anonymous" />
                </div>
            </div>
            <div class="form-group row">
                <label class="col-2 col-form-label text-right">Message</label>
                <div class="col-10">
                    <input type="text" class="form-control" id="guestbook-message" v-on:keypress.enter="postClick" />
                </div>
            </div>
            <div class="form-group row">
                <div class="col-2"></div>
                <div class="col-10">
                    <input type="button" class="btn btn-primary" value="Post" v-on:click="postClick" />
                </div>
            </div>
            <div class="guestbook-posts mt-4" v-cloak>
                <div v-for="p in posts" class="d-flex">
                    <div class="guestbook-posts-name ml-1 mr-1 text-nowrap d-flex align-items-start">[[ p.name ]]</div>
                    <div class="guestbook-posts-message ml-1 mr-1">[[ p.message ]]</div>
                    <div class="guestbook-posts-datetime ml-1 mr-1 mb-1 text-nowrap d-flex align-items-end">([[ toDatetime(p.timestamp) ]])</div>
                </div>
            </div>
        </div>
    </body>
</html>
